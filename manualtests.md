# בדיקות ידניות - תמיכה ברב-חונכים

## סיכום שינויים בקוד

### קבצים שהשתנו:
1. **`utils.py`** - `fetch_possible_matches()`: SQL משונה להכיל את כל הילדים (גם עם חונכים) לטובת הדוח
2. **`utils.py`** - `deactivate_staff()`: שימוש ב-PrevTutorshipStatuses לשחזור סטטוס ילד
3. **`tutorship_views.py`** - `calculate_possible_matches()`: סינון לאשף - מחזיר רק ילדים עם 0 חונכים
4. **`tutorship_views.py`** - `create_tutorship()`: הסרת מחיקת חונכויות ממתינות, PrevTutorshipStatuses רק לחונכות ראשונה
5. **`tutorship_views.py`** - `delete_tutorship()`: שחזור סטטוס ילד רק אם זו החונכות האחרונה
6. **`family_views.py`** - `update_family()`: מחיקת חונכויות (לא inactive) כשילד נפטר/בריא

### לוגיקה חדשה:
- **ילד יכול** להיות עם מספר חונכים
- **חונך מוגבל** לחניך אחד בלבד
- **PrevTutorshipStatuses** נשמר רק לחונכות הראשונה, משוחזר רק כשמוחקים את האחרונה
- **חונכות inactive** היא רק לזרימת השבתת צוות (לא לנפטר/בריא)
- **אשף** מציג רק ילדים עם 0 חונכים, **דוח** מציג את כולם

---

## 1. יצירת חונכות ורב-חונכים

### בדיקה 1.1: יצירת חונכות ראשונה לילד
**תנאי קדם:** ילד קיים עם סטטוס `למצוא_חונך`

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נווט לאשף החונכויות | האשף נפתח |
| 2 | הרץ "חשב התאמות" | התאמות חושבו, הילד מופיע ברשימה |
| 3 | בחר התאמה וצור חונכות | חונכות נוצרה עם סטטוס `pending_first_approval` |
| 4 | בדוק סטטוס ילד | השתנה ל-`יש_חונך` |
| 5 | בדוק סטטוס חונך | השתנה ל-`יש_חניך` |
| 6 | בדוק PrevTutorshipStatuses | רשומה נוצרה עם הסטטוסים המקוריים |

### בדיקה 1.2: יצירת חונכות שנייה לאותו ילד (רב-חונכים)
**תנאי קדם:** לילד יש חונך פעיל אחד, סטטוס `יש_חונך`

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נווט לדוח התאמות אפשריות | הדוח נפתח |
| 2 | וודא שהילד מופיע בדוח | ילד עם חונך כן מופיע (לשיבוץ רב-חונכים) |
| 3 | בחר חונך אחר לאותו ילד | דיאלוג שיבוץ ידני נפתח |
| 4 | צור חונכות דרך שיבוץ ידני | חונכות נוצרה |
| 5 | בדוק סטטוס ילד | נשאר `יש_חונך` |
| 6 | בדוק סטטוס חונך חדש | השתנה ל-`יש_חניך` |
| 7 | בדוק PrevTutorshipStatuses | לא נוצרה רשומה חדשה (רק לחונכות ראשונה) |
| 8 | בדוק חונכות קיימת | החונכות המקורית לא נמחקה (תמיכה ברב-חונכים) |

### בדיקה 1.3: וידוא שהאשף מסנן ילדים עם חונכים
**תנאי קדם:** חלק מהילדים עם חונכים, חלק בלי

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נווט לאשף החונכויות | האשף נפתח |
| 2 | הרץ "חשב התאמות" | התאמות חושבו |
| 3 | בדוק אילו ילדים מוצגים | רק ילדים עם 0 חונכים מופיעים באשף |
| 4 | בדוק שהדוח מציג את כולם | הדוח מציג את כל הילדים (כולל עם חונכים) |

---

## 2. מחיקת חונכות

### בדיקה 2.1: מחיקת חונכות כשיש לילד מספר חונכים
**תנאי קדם:** לילד יש 2+ חונכים פעילים

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נווט לרשימת החונכויות | הרשימה נפתחת |
| 2 | מחק אחת מהחונכויות | החונכות נמחקה |
| 3 | בדוק סטטוס ילד | נשאר `יש_חונך` (עדיין יש חונכים אחרים) |
| 4 | בדוק סטטוס החונך שנמחק | חזר ל-`אין_חניך` |
| 5 | בדוק חונכויות שנשארו | ללא שינוי |

### בדיקה 2.2: מחיקת החונכות האחרונה לילד
**תנאי קדם:** לילד יש בדיוק חונך אחד פעיל עם רשומת PrevTutorshipStatuses

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | מחק את החונכות | החונכות נמחקה |
| 2 | בדוק סטטוס ילד | שוחזר מ-PrevTutorshipStatuses (למשל `למצוא_חונך`) |
| 3 | בדוק סטטוס חונך | שוחזר מ-PrevTutorshipStatuses (`אין_חניך`) |
| 4 | בדוק PrevTutorshipStatuses | הרשומה נמחקה אחרי השחזור |

### בדיקה 2.3: מחיקת חונכות ללא PrevTutorshipStatuses
**תנאי קדם:** לילד יש חונך אחד, אין רשומת PrevTutorshipStatuses

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | מחק את החונכות | החונכות נמחקה |
| 2 | בדוק סטטוס ילד | ברירת מחדל `למצוא_חונך` |
| 3 | בדוק סטטוס חונך | ברירת מחדל `אין_חניך` |

---

## 3. השבתת והפעלת צוות

### בדיקה 3.1: השבתת צוות עם חונכות יחידה
**תנאי קדם:** איש צוות הוא חונך עם חונכות פעילה אחת, לילד יש רק חונך זה

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נווט לניהול צוות | רשימת הצוות נפתחת |
| 2 | השבת את החונך | דיאלוג השבתה נפתח |
| 3 | הכנס סיבה ואשר | הצוות הושבת |
| 4 | בדוק תפקידי הצוות | תפקידים נמחקו, רק תפקיד "Inactive" מוקצה |
| 5 | בדוק חונכות | החונכות המקורית נמחקה, עותק INACTIVE נוצר |
| 6 | בדוק סטטוס ילד | שוחזר מ-PrevTutorshipStatuses או ברירת מחדל `למצוא_חונך` |
| 7 | בדוק שהחונך עדיין זמין | החונך מופיע בהתאמות (יש לו חונכות inactive, לא active) |

### בדיקה 3.2: השבתת צוות כשלילד יש מספר חונכים
**תנאי קדם:** איש צוות הוא חונך, לילד יש 2 חונכים (זה + אחר)

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | השבת את החונך | הצוות הושבת |
| 2 | בדוק חונכות | עותק inactive נוצר |
| 3 | בדוק סטטוס ילד | נשאר `יש_חונך` (עדיין יש חונך פעיל) |
| 4 | בדוק חונך אחר | החונכות שלו ללא שינוי |

### בדיקה 3.3: הפעלת צוות מחדש
**תנאי קדם:** צוות הושבת, יש לו חונכות inactive

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | הפעל מחדש את הצוות | הצוות הופעל |
| 2 | בדוק תפקידים | התפקידים הקודמים שוחזרו |
| 3 | בדוק חונכות | החונכות ה-inactive נשארת (ניתן להפעיל ידנית) |
| 4 | בדוק שהצוות יכול להיות משובץ | הצוות מופיע בחונכים זמינים |

### בדיקה 3.4: אי אפשר ליצור חונכות פעילה לצוות מושבת
**תנאי קדם:** צוות מושבת (יש לו תפקיד Inactive)

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נסה ליצור חונכות דרך האשף | צוות מושבת לא אמור להופיע בהתאמות |
| 2 | נסה שיבוץ ידני עם צוות מושבת | אמור להימנע (בדיקת staff.is_active = FALSE) |

---

## 4. שינוי סטטוס ילד (נפטר/בריא)

### בדיקה 4.1: ילד נפטר
**תנאי קדם:** לילד יש 1+ חונכים פעילים

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נווט לעריכת משפחה | פרטי המשפחה נפתחים |
| 2 | שנה סטטוס ל-`ז״ל` או `ז"ל` | הסטטוס השתנה |
| 3 | שמור שינויים | המשפחה נשמרה |
| 4 | בדוק חונכויות | כל החונכויות נמחקו (לא inactive) |
| 5 | בדוק חונכים | סטטוס כל החונכים חזר ל-`אין_חניך` |
| 6 | בדוק PrevTutorshipStatuses | רשומות לילד זה נמחקו |
| 7 | בדוק שהילד לא בהתאמות | הילד מוחרג מהאשף ומהדוח |

### בדיקה 4.2: ילד הבריא
**תנאי קדם:** לילד יש 1+ חונכים פעילים

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נווט לעריכת משפחה | פרטי המשפחה נפתחים |
| 2 | שנה סטטוס ל-`בריא` | הסטטוס השתנה |
| 3 | שמור שינויים | המשפחה נשמרה |
| 4 | בדוק חונכויות | כל החונכויות נמחקו (לא inactive) |
| 5 | בדוק חונכים | סטטוס כל החונכים חזר ל-`אין_חניך` |
| 6 | בדוק PrevTutorshipStatuses | רשומות לילד זה נמחקו |
| 7 | בדוק שהילד לא בהתאמות | הילד מוחרג מהאשף ומהדוח |

---

## 5. זרימת אישור חונכות

### בדיקה 5.1: מאשר ראשון
**תנאי קדם:** חונכות בסטטוס `pending_first_approval`

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | אשר חונכות כמאשר ראשון | approval_counter = 1 |
| 2 | בדוק סטטוס | עדיין `pending_first_approval` |

### בדיקה 5.2: מאשר שני (תפקיד שונה)
**תנאי קדם:** לחונכות יש approval_counter = 1

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | אשר עם תפקיד שונה | approval_counter = 2 |
| 2 | בדוק סטטוס | השתנה ל-`active` |
| 3 | בדוק תפקיד חונך | תפקיד "Tutor" נוסף לצוות |

### בדיקה 5.3: אותו תפקיד לא יכול לאשר פעמיים
**תנאי קדם:** לחונכות יש approval_counter = 1, אותו תפקיד מנסה לאשר

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נסה לאשר עם אותו תפקיד | שגיאה: "תפקיד זה כבר אישר" |
| 2 | בדוק approval_counter | ללא שינוי |

---

## 6. מקרי קצה

### בדיקה 6.1: חונך יכול להיות עם חניך אחד בלבד
**תנאי קדם:** לחונך יש חונכות פעילה

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | הרץ חישוב התאמות | החונך לא אמור להופיע בחונכים זמינים |
| 2 | בדוק בדוח | החונך לא מוצג לשום ילד אחר |

### בדיקה 6.2: זוג ילד-חונך כבר קיים
**תנאי קדם:** חונכות פעילה קיימת לזוג ילד+חונך

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נסה ליצור חונכות כפולה | שגיאה: "חונכות כבר קיימת" |
| 2 | בדוק מסד נתונים | לא נוצר כפול |

### בדיקה 6.3: חונכות inactive לא חוסמת חונכות חדשה
**תנאי קדם:** לחונך יש חונכות INACTIVE (מהשבתת צוות), הצוות עכשיו פעיל שוב

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | הפעל מחדש צוות | הצוות פעיל |
| 2 | הרץ חישוב התאמות | החונך מופיע בחונכים זמינים |
| 3 | צור חונכות חדשה | הצלחה - חונכות inactive לא חוסמת |
| 4 | בדוק חונכות inactive ישנה | נוקתה (נמחקה) בזמן יצירת החונכות החדשה |

### בדיקה 6.4: התאמת מגדר
**תנאי קדם:** ילד זכר, חונכת נקבה (או להפך)

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | הרץ חישוב התאמות | רק התאמות מאותו מגדר מוצגות |
| 2 | בדוק התאמת מגדר | מגדר ילד = מגדר חונך |

---

## 7. אימות דוחות

### בדיקה 7.1: דוח התאמות אפשריות מציג את כל הילדים
**תנאי קדם:** תערובת של ילדים עם/בלי חונכים

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נווט לדוח התאמות אפשריות | הדוח נפתח |
| 2 | בדוק אילו ילדים מוצגים | כל הילדים מוצגים (עם ובלי חונכים) |
| 3 | בדוק ילדים עם חונכים | מסומנים/מצוין שיש להם חונכים קיימים |

### בדיקה 7.2: טבלת PossibleMatches מכילה את כל ההתאמות
**תנאי קדם:** חישוב התאמות הורץ

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | שאל את טבלת PossibleMatches | מכילה התאמות לכל הילדים |
| 2 | בדוק ילדים עם חונכים | נכללים בטבלה (לטובת הדוח) |
| 3 | בדוק סינון האשף | האשף מציג תת-קבוצה (רק 0 חונכים) |

---

## 8. תצוגת משפחה

### בדיקה 8.1: הצגת מספר חונכים
**תנאי קדם:** לילד יש 2+ חונכים

| שלב | פעולה | תוצאה צפויה |
|-----|-------|-------------|
| 1 | נווט לכרטיס משפחה | פרטי המשפחה נפתחים |
| 2 | צפה בסעיף חונכים | כל החונכים מוצגים (רשימה, לא בודד) |
| 3 | בדוק פרטי חונכים | שם וסטטוס של כל חונך מוצג |

---

## רשימת בדיקות לסיכום

| פיצ'ר | נבדק | עבר/נכשל | הערות |
|-------|------|----------|-------|
| חונכות ראשונה יוצרת PrevTutorshipStatuses | ☐ | | |
| חונכות שנייה+ לא יוצרת PrevTutorshipStatuses | ☐ | | |
| מחיקת חונכות עם חונכים אחרים משאירה סטטוס ילד | ☐ | | |
| מחיקת חונכות אחרונה משחזרת סטטוס ילד | ☐ | | |
| השבתת צוות יוצרת עותק חונכות inactive | ☐ | | |
| השבתת צוות משחזרת סטטוס ילד אם חונך אחרון | ☐ | | |
| השבתת צוות משאירה סטטוס ילד אם יש חונכים אחרים | ☐ | | |
| צוות מושבת לא מופיע בהתאמות | ☐ | | |
| חונכויות ילד נפטר/בריא נמחקות (לא inactive) | ☐ | | |
| PrevTutorshipStatuses של ילד נפטר/בריא נוקה | ☐ | | |
| אשף מציג רק ילדים עם 0 חונכים | ☐ | | |
| דוח מציג את כל הילדים (לרב-חונכים) | ☐ | | |
| חונך מוגבל לחניך אחד | ☐ | | |
| חונכות inactive לא חוסמת חונכות חדשה | ☐ | | |
| התאמת מגדר עובדת | ☐ | | |
