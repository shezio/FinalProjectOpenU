# תשובות להחלטת ריבוי חונכים + הסבר PrevTutorshipStatuses

---

## 🔑 הסבר על PrevTutorshipStatuses - למה זה קיים?

### הבעיה שנפתרה:

כשיוצרים חונכות חדשה, הסטטוסים של הילד והחונך **משתנים**:
- סטטוס הילד משתנה ל-`יש_חונך`
- סטטוס החונך משתנה ל-`יש_חניך`

**אבל מה קורה אם מוחקים את החונכות?**

בלי לשמור את הסטטוסים הקודמים, לא נדע מה היה לפני:
- האם הילד היה `מחפש_חונך`? או אולי `לא_רוצה`?
- האם החונך היה `אין_חניך`? או אולי `לא_זמין`?

### הפתרון - טבלת PrevTutorshipStatuses:

```
┌─────────────────────────────────────────────────────────────┐
│                   PrevTutorshipStatuses                      │
├─────────────────────────────────────────────────────────────┤
│ tutorship_id          → מצביע לחונכות הספציפית              │
│ prev_tutoring_status  → הסטטוס הקודם של הילד               │
│ prev_tutorship_status → הסטטוס הקודם של החונך              │
└─────────────────────────────────────────────────────────────┘
```

### דוגמה:

**לפני יצירת חונכות:**
- ילד #5: סטטוס = `מחפש_חונך`
- חונך #10: סטטוס = `אין_חניך`

**יצירת חונכות:**
1. נוצרת חונכות #100 (ילד #5 + חונך #10)
2. סטטוס ילד #5 → `יש_חונך`
3. סטטוס חונך #10 → `יש_חניך`
4. **נשמר ב-PrevTutorshipStatuses:**
   - tutorship_id = 100
   - prev_tutoring_status = `מחפש_חונך`
   - prev_tutorship_status = `אין_חניך`

**מחיקת חונכות:**
1. מוחקים חונכות #100
2. קוראים מ-PrevTutorshipStatuses את הסטטוסים הקודמים
3. סטטוס ילד #5 → `מחפש_חונך` (חזר למה שהיה!)
4. סטטוס חונך #10 → `אין_חניך` (חזר למה שהיה!)

### למה זה קריטי לריבוי חונכים?

**בעיה חדשה:** אם לילד יש 2 חונכים ומוחקים אחד:

```
ילד #5 ← חונך #10 (חונכות #100)
ילד #5 ← חונך #20 (חונכות #200)
```

אם מוחקים חונכות #100:
- הקוד הנוכחי יחזיר את סטטוס ילד #5 ל-`מחפש_חונך`
- **אבל לילד עדיין יש חונך #20!** זה שגוי!

**הפתרון הנדרש:** לא לשחזר סטטוס ילד אם יש לו עדיין חונכויות פעילות אחרות.

---

## ✅ תשובות לשאלות

### שאלה 1: מספר חונכים מקסימלי לילד
**תשובה:** מקסימום 100 (בפועל לא באמת משנה - אין הגבלה אמיתית)

### שאלה 2: סטטוס ילד עם חונך אחד מתוך מקסימום
**תשובה:** תלוי בטבלת PrevTutorshipStatuses - ראה הסבר למעלה.

הלוגיקה החדשה צריכה להיות:
```
אם יש לפחות חונכות פעילה אחת → יש_חונך
אחרת → להחזיר לסטטוס מ-PrevTutorshipStatuses
```

### שאלה 3: האם חונך יכול לחנוך כמה ילדים?
**תשובה:** ❌ **לא** - כל חונך יכול לחנוך **ילד אחד בלבד**

### שאלה 4: מה קורה כשמוחקים חונכות אחת מתוך כמה?
**תשובה:** 
```
אם מספר_חונכים_פעילים >= 1 → יש_חונך
אחרת → מחפש_חונך (או הסטטוס מ-PrevTutorshipStatuses)
```

### שאלה 5: איך להציג את המידע בממשק?
**תשובה:** להציג **רשימת כל החונכים** של הילד

### שאלה 6: מה לגבי אלגוריתם ההתאמה?
**תשובה:** 
- לאפשר לילדים להופיע גם אם יש להם כבר חונך (אפשר להוסיף עוד)
- **לא להציג חונכים שכבר יש להם חניך** (כי חונך = ילד אחד בלבד)
- **נדרש שינוי UNIQUE KEY בבסיס הנתונים** - כרגע יש constraint שמונע כפילויות

### שאלה 7: מה לגבי הפידבקים?
**תשובה:** ✅ **אין שינוי** - אפשר למלא כמה פידבקים שרוצים על כל ילד

### שאלה 8: מה לגבי המשימות?
**תשובה:** ✅ **אין שינוי** - משימות נוצרות ידנית ולא קשורות לריבוי חונכים

### שאלה 9 (חדשה): חונך שעזב אבל לילד יש עוד חונכים
**תשובה:** צריך לטפל במקרה הזה:
- כשחונך עוזב (מחיקת חונכות):
  - סטטוס החונך → `אין_חניך` (או מה שהיה ב-PrevTutorshipStatuses)
  - סטטוס הילד → **לבדוק אם יש עוד חונכויות פעילות:**
    - אם כן → להשאיר `יש_חונך`
    - אם לא → לשחזר מ-PrevTutorshipStatuses

---

## 📋 סיכום השינויים הנדרשים

| מה צריך לשנות | תיאור |
|---------------|--------|
| **אלגוריתם התאמה** | להציג ילדים גם אם יש להם חונך, לא להציג חונכים עם חניך |
| **UNIQUE KEY בDB** | להסיר או לשנות את ה-constraint שמונע כפילויות |
| **מחיקת חונכות** | לבדוק אם יש עוד חונכויות לפני שחזור סטטוס ילד |
| **תצוגת משפחה** | להציג רשימת כל החונכים במקום חונך אחד |
| **יצירת חונכות** | לא לשנות סטטוס ילד אם כבר `יש_חונך` |

---

## 🔧 לוגיקה חדשה למחיקת חונכות

```python
def delete_tutorship(tutorship):
    child = tutorship.child
    tutor = tutorship.tutor
    
    # 1. שחזור סטטוס החונך - תמיד
    prev_status = PrevTutorshipStatuses.objects.filter(tutorship=tutorship).first()
    if prev_status:
        tutor.tutorship_status = prev_status.prev_tutorship_status
    else:
        tutor.tutorship_status = "אין_חניך"
    tutor.save()
    
    # 2. בדיקה אם לילד יש עוד חונכויות פעילות
    other_tutorships = Tutorships.objects.filter(
        child=child, 
        status='פעיל'
    ).exclude(id=tutorship.id).exists()
    
    # 3. שחזור סטטוס הילד - רק אם אין עוד חונכויות
    if not other_tutorships:
        if prev_status:
            child.tutoring_status = prev_status.prev_tutoring_status
        else:
            child.tutoring_status = "מחפש_חונך"
        child.save()
    # אם יש עוד חונכויות - לא משנים את סטטוס הילד (נשאר יש_חונך)
    
    # 4. מחיקת רשומת הסטטוס הקודם
    if prev_status:
        prev_status.delete()
    
    # 5. מחיקת החונכות
    tutorship.delete()
```

---

*מסמך זה נוצר בתאריך: 25/01/2026*
